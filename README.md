# –ü—Ä–æ–µ–∫—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ: ETL

## –ó–∞–¥–∞–Ω–∏–µ —Å–ø—Ä–∏–Ω—Ç–∞

–ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã–π –ø–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ Postgres –≤ Elasticsearch

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–∞—è [c—Ö–µ–º—É –∏–Ω–¥–µ–∫—Å–∞](https://code.s3.yandex.net/middle-python/learning-materials/es_schema.txt)üíæ  `movies`, 
  –±—ã–ª–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ —Ñ–∞–π–ª `movies.json`. –ó–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ ElasticSearch –æ—Ç–≤–µ—á–∞–µ—Ç –∫–ª–∞—Å—Å 
  `EtlProcess`. –¢–∞–∫–æ–π json-—Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ `config` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤ –∫–æ—Ç–æ—Ä—ã–π –¥–∞–Ω–Ω—ã–µ
  –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —ç—Ç–æ–≥–æ ETL.
- ETL –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü SQL –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–æ–≤ 
  ElasticSearch. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –≤ —Ñ–∞–π–ª–µ `config/settings.toml` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å–≤—è–∑–∏ —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ SQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
  –≠—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å–≤—è–∑—è–º–∏ 1-–∫-1, –æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º, –º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º. –ó–∞ —Å—á–µ—Ç —ç—Ç–æ–≥–æ
  —Å–∏—Å—Ç–µ–º–∞ –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è. –í –∏—Ç–æ–≥–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ª—É—á–µ–Ω–∞ —á–µ—Ä–µ–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–æ—Å,
  –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –º–∞—Å—Å–∏–≤—ã.
- –í –º–æ–Ω–∏—Ç—Ä–æ–∏–Ω–≥ —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–≤—è–∑—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã `genre_film_work` –∏ `person_film_work` –ø–æ –ø–æ–ª—é `created`. –ò–Ω–∞—á–µ –ø—Ä–∏ 
  –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–∫—Ç–µ—Ä–æ–≤ –∏–ª–∏ –∂–∞–Ω—Ä–æ–≤ –∫ —Ñ–∏–ª—å–º—É –∏–Ω–¥–µ–∫—Å ElasticSearch –Ω–µ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—è. –ù–µ—Ä–µ—à–µ–Ω–Ω–æ–π —è–≤–ª—è–µ—Ç—Å—è —Å–∏—Ç—É–∞—Ü–∏—è —Å 
  —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö. –¢—É—Ç –ø–æ –∏–¥–µ–µ –±—É–¥–µ—Ç –≤—Å–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –Ω–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –∞ —á–µ—Ä–µ–∑ –ø–æ–ª–µ
  is_actual - –∫–æ–¥ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å.
- –ï—Å–ª–∏ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—ã–±–æ—Ä–∫–∏ —Ñ–∏–ª—å–º–æ–≤ —É –∫–æ—Ç–æ—Ä—ã—Ö –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, —Ç–æ –ø–æ–ª—É—á–∏—Ç—Å—è
  —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –º—ã —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏–º –≤—Å–µ —Ñ–∏–ª—å–º—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ, –∞ –∑–∞—Ç–µ–º –∏—Ö –±—É–¥–µ–º –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∂–∞–Ω—Ä–∞,
  –ø–µ—Ä—Å–æ–Ω—ã –∏ —Ç.–¥. –î–ª—è —ç—Ç–æ–≥–æ –¥–æ–±–∞–≤–∏–ª –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–æ–ª—è —Ç–∞–±–ª–∏—Ü 
  `compare_field_actual_with_parent_query` –∏ `compare_field_actual_for_child_queries`. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Ñ–ª–∞–≥–∞ –≤ 1
  –∑–∞–¥–∞–µ—Ç, —á—Ç–æ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç–∞–±–ª–∏—Ü—ã –±—É–¥—É—Ç –æ–±–∏—Ä–∞—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–µ `modified`/`created` –±–æ–ª—å—à–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ –ø–æ–ª—è
  —É –≥–æ–ª–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã.
- –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ ETL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ python —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º —Å–∫—Ä–∏–ø—Ç–∞.
- –ü–æ—Å–º–æ—Ç—Ä–µ–ª, —á—Ç–æ —Ç–∞–∫–æ–µ –∫–æ—Ä—É—Ç–∏–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–∏–ª –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö (–≤ —ç—Ç—É –ø—è—Ç–Ω–∏—Ü—É –¥–æ–ª–∂–Ω—ã —Ä–∞–∑–±–∏—Ä–∞—Ç—å –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä–µ).
- –ü—Ä–æ–µ–∫—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ PosgtresSQL, Radis, ElasticSearch.

### –°–≤—è–∑–∏ –º–µ–∂–¥—É –∏–Ω–¥–µ–∫—Å–æ–º ElasticSearch –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏ SQL –≤ –∫–æ–Ω—Ñ–∏–≥. —Ñ–∞–π–ª–µ: 
```
"bindings_elastic_to_sql": [
      ..., # –°–≤—è–∑–∞–Ω–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —Ç–∞–±–ª–∏—Ü –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ
      {
         "elastic_index": "movies", # –ò–º—è –∏–Ω–¥–µ–∫—Å–∞
         "transform_class": "MoviesDataTransform", # –ò–º—è –∫–ª–∞—Å—Å–∞ –≤ —Ñ–∞–π–ª–µ etl_data_transform.py, –æ—Ç–≤–µ—á–∞—é—â–µ–≥–æ –∑–∞ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º. –¥–∞–Ω–Ω—ã—Ö.
         "mapping_file": "es_movies.json", # –ò–º—è —Ñ–∞–π–ª–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏ –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –∏–Ω–¥–µ–∫—Å. 
         "table": { # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ SQL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            "name": "film_work",
            "alias": "fw",
            "fields": [ 
                # –ü–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø–∞–¥—É—Ç –≤ –≤—ã–±–æ—Ä–∫—É
               "id",
               "title",
               "description",
               "rating",
               "modified"
            ],
            "aliases": {
               # –ü—Å–µ–≤–¥–æ–Ω–∏–º–∏ –¥–ª—è –ø–æ–ª–µ–π —Ç–∞–±–ª–∏—Ü, —á—Ç–æ–±—ã —É–ø—Ä–æ—Å–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö.
               "rating": "imdb_rating"
            },
            "field_actual_state_name": "modified", # –ü–æ–ª–µ –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π.
            compare_field_actual_for_child_queries = 1, # –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —ç—Ç–æ—Ç —Ñ–ª–∞–≥, —Ç–æ –¥–ª—è –≤—Å–µ—Ö –¥–æ—á–µ—Ä–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ fw.modified < alias.(modified/created).
                                                        # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –≤—ã–≥—Ä—É–∑–æ–∫ —Ñ–∏–ª—å–º–æ–≤ –ø—Ä–∏ –ø—Ä–æ—Ö–æ–¥–µ –ø–æ –¥–æ—á–µ—Ä–Ω–∏–º —Ç–∞–±–ª–∏—Ü–∞–º.
            "children": [ # –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π —Ç–∞–±–ª–∏—Ü—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å 2 –¥–ª—è —Å–≤—è–∑–µ–π –º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º.
               {
                  "name": "genre_film_work",
                  "alias": "gfw",
                  "group": "genre", # –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã, –µ—Å–ª–∏ –≤ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ –æ–¥–Ω–æ –ø–æ–ª–µ - –±—É–¥–µ—Ç –º–∞—Å—Å–∏–≤, –Ω–µ—Å–∫–æ–ª—å–∫–æ - JSON.
                  "join": {
                     "film_work_id": "id" # –ü–æ–ª–µ –¥–æ—á–µ—Ä–Ω–µ–π —Ç–∞–±–∏—Ü—ã: –ü–æ–ª–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∫–æ—Ç–æ—Ä—ã–º –¥–µ–ª–∞–µ—Ç—Å—è JOIN.
                  },
                  "children": [
                     {
                        "name": "genre",
                        "alias": "gr",
                        "join": {
                           "id": "genre_id"
                        },
                        "fields": [
                           "name"
                        ],
                        "field_actual_state_name": "modified"
                     }
                  ]
               },
               {
                  "name": "person_film_work",
                  "alias": "pfw",
                  "group": "persons",
                  "fields": [
                     "role"
                  ],
                  "join": {
                     "film_work_id": "id"
                  },
                  "children": [
                     {
                        "name": "person",
                        "alias": "pn",
                        "join": {
                           "id": "person_id"
                        },
                        "fields": [
                           "id",
                           "full_name",
                           "modified"
                        ],
                        "aliases": {
                           "full_name": "name"
                        },
                        "field_actual_state_name": "modified"
                     }
                  ]
               }
            ]
         }
      }
   ]
```

### –ü—Ä–∏–º–µ—Ä SQL-–∑–∞–ø—Ä–æ—Å–∞, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ETL –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥. —Ñ–∞–π–ª–∞:
```
            SELECT 
                "fw"."id" AS "id",
                "fw"."title" AS "title",
                "fw"."description" AS "description",
                "fw"."rating" AS "imdb_rating",
                "fw"."modified" AS "modified",
                array_agg (DISTINCT "gr"."name") AS "genre",
                COALESCE (json_agg(DISTINCT jsonb_build_object(
                    'role', "pfw"."role", 
                    'id', "pn"."id", 
                    'name', "pn"."full_name", 
                    'modified', "pn"."modified"
                )) FILTER (WHERE "pn"."modified" is not null), '[]') AS "persons",
                "_tracked_table"."_tracked_field" 
            FROM "content"."film_work" AS "fw"
            LEFT JOIN "content"."genre_film_work" AS "gfw" ON ("fw"."id" = "gfw"."film_work_id")
            LEFT JOIN "content"."genre" AS "gr" ON ("gfw"."genre_id" = "gr"."id")
            LEFT JOIN "content"."person_film_work" AS "pfw" ON ("fw"."id" = "pfw"."film_work_id")
            LEFT JOIN "content"."person" AS "pn" ON ("pfw"."person_id" = "pn"."id")
            JOIN (
                SELECT DISTINCT "fw"."id" AS "id", pn.modified AS "_tracked_field"
                FROM "content"."film_work" AS "fw"
                JOIN "content"."person_film_work" AS "pfw" ON "fw"."id" = "pfw"."film_work_id"
                JOIN "content"."person" AS "pn" ON "pfw"."person_id" = "pn"."id"
                WHERE "fw"."modified" < pn.modified AND pn.modified > %s 
                ORDER BY pn.modified
                LIMIT 10000 OFFSET %s
            ) AS "_tracked_table" ON "fw"."id" = "_tracked_table"."id"  
            GROUP BY
            "fw"."id",
            "fw"."title",
            "fw"."description",
            "fw"."rating",
            "fw"."modified",
            "_tracked_table"."_tracked_field"
            LIMIT 10000
```

P.S. –ö–æ–¥–∞ –º–Ω–æ–≥–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –Ω–µ –æ—á–µ–Ω—å —á–∏—Ç–µ–ª—å–Ω–æ, –º–Ω–µ –∫–∞–∂–µ—Ç—Å—è. –ë—É–¥—É –±–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º)
